services:
  namenode:
    image: apache/hadoop:3.4.2
    platform: linux/amd64
    hostname: namenode
    command: ["hdfs", "namenode"]
    environment:
      ENSURE_NAMENODE_DIR: /tmp/hadoop-hadoop/dfs/name
    env_file:
      - ./hadoop-e2e.env
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9870/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  datanode:
    image: apache/hadoop:3.4.2
    platform: linux/amd64
    hostname: datanode
    command: ["hdfs", "datanode"]
    env_file:
      - ./hadoop-e2e.env
    depends_on:
      namenode:
        condition: service_healthy

  hdfs-app:
    build:
      context: .
      dockerfile: Dockerfile.e2e
    environment:
      HDFS_NAMENODE_HOST: namenode
      HDFS_NAMENODE_PORT: "9870"
      HDFS_USER: hadoop
      PORT: "3001"
      SESSION_SECRET: e2e-test-secret
      LOCAL_USERS_FILE: /app/e2e-users.json
    volumes:
      - ./e2e/users.json:/app/e2e-users.json:ro
    depends_on:
      datanode:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:3001/api/health').then(r=>{if(!r.ok)process.exit(1)}).catch(()=>process.exit(1))\""]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s

  ldap:
    image: osixia/openldap:1.5.0
    environment:
      LDAP_ORGANISATION: Example
      LDAP_DOMAIN: example.com
      LDAP_ADMIN_PASSWORD: adminpassword
      LDAP_SEED_INTERNAL_LDIF_PATH: /ldif
    volumes:
      - ./scripts/ldap-seed.ldif:/ldif/seed.ldif:ro
    healthcheck:
      test: ["CMD-SHELL", "ldapwhoami -x -H ldap://localhost:389 -D cn=admin,dc=example,dc=com -w adminpassword"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  hdfs-app-ldap:
    build:
      context: .
      dockerfile: Dockerfile.e2e
    environment:
      HDFS_NAMENODE_HOST: namenode
      HDFS_NAMENODE_PORT: "9870"
      HDFS_USER: hadoop
      PORT: "3001"
      SESSION_SECRET: e2e-test-secret
      AUTH_MODE: ldap
      LDAP_URL: ldap://ldap:389
      LDAP_USER_DN_PATTERN: "cn=%s,ou=users,dc=example,dc=com"
    depends_on:
      datanode:
        condition: service_started
      ldap:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:3001/api/health').then(r=>{if(!r.ok)process.exit(1)}).catch(()=>process.exit(1))\""]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s

  seed:
    image: curlimages/curl:latest
    depends_on:
      hdfs-app:
        condition: service_healthy
    volumes:
      - ./scripts/seed-hdfs-e2e.sh:/seed.sh:ro
    entrypoint: ["sh", "/seed.sh"]

  playwright:
    image: mcr.microsoft.com/playwright:v1.58.2-noble
    working_dir: /work
    environment:
      BASE_URL: http://hdfs-app:3001
      LDAP_BASE_URL: http://hdfs-app-ldap:3001
    volumes:
      - .:/work
      - ./test-results:/work/test-results
      - ./playwright-report:/work/playwright-report
    entrypoint: ["sh", "-c", "npm ci --ignore-scripts && npx playwright test"]
    depends_on:
      seed:
        condition: service_completed_successfully
      hdfs-app-ldap:
        condition: service_healthy
